<%= flash[:notice] %>

<div class="user_show">
  <div class="container">
      <div class="col-lg-3">

        <div class="user_info">
          <div class="user_content">
            <h4>ユーザ情報</h4>
            <% if @user.image.attached? %>
                <p><%= image_tag @user.image, size:"70x70" %></p>
            <% else %>
                <p><%= image_tag "no_image.png", size:"70x70" %></p>
            <% end %>
            <p><%= @user.name %></p>
            <p><%= @user.email%></p>

            <%= link_to "プロフ編集画面", edit_user_path(@user) %>
          </div>
        </div>

        <div class="post_all">
          <div class="post_content">
          <h4>投稿の一覧</h4>
            <div class="post_each">
              <% @posts.each do |post| %>
                  ・<%= link_to post_path(post.id) do %><%= post.title %><% end %><br><br>
              <% end %>
            </div>
          </div>
        </div>
      </div>

    <div class="col-lg-9">
      <div class="right">
        <div class="stopwatch">
          <div class="timer_content">
            <div id="clock">00:00:00</div><br>
            <form>
                <input type="button" id="start" value="Start">
                <input type="button" id="stop" value="Stop" disabled>
                <input type="button" id="restart" value="Restart" disabled>
                <input type="button" id="finish" value="finish" disabled>
            </form>
          </div>
        </div>

        <%= link_to new_post_path do %>
        <div class="post_new">
            <div class="post_link">投稿する</div>
        </div>
        <% end %>
      </div>
    </div>
  </div>
</div>


<script>
$(function () {
  var sec = 0;
  var min = 0;
  var hour = 0;

  var timer;

  // スタート
  $(document).on("click", "#start",function() {
    // 00:00:00から開始
    sec = 0;
    min = 0;
    hour = 0;
    $('#clock').html('00:00:00');
    timer = setInterval(countup, 1000);

    $(this).prop('disabled', true);
    $('#stop,#reset').prop('disabled', false);
    $("#finish").prop("disabled",false);

    $(window).bind("beforeunload", function(){
      return ('離れる？');
    });
    $(document).on("click","#show_a", function(){
      if(confirm("このページから移動するとタイマーが止まります。遷移しますか？")){
        return true;
      } else {
        return false;
      }
    });
  });

  // ストップ
  $('#stop').click(function() {
    // 一時停止
    clearInterval(timer);

    $(this).prop('disabled', true);
    $('#restart').prop('disabled', false);

  });

  // リスタート
  $('#restart').click(function() {
    // 一時停止から再開
    timer = setInterval(countup, 1000);

    $(this).prop('disabled', true);
    $('#stop').prop('disabled', false);
  });

  $(document).on('click', "#finish", function(){
        var count = $("#clock").text();

        const hour = count.slice(0, 2);
        const min = count.slice(3, 5);
        const sec = count.slice(6, 8);

        console.log(hour);
        console.log(min);
        console.log(sec);


        $.ajax({
          url: "http://localhost:3000/timers",
          type: "POST",
          datatype :"json",
          data: {timer: {hour: hour, min: min, sec: sec}}
        })
        .done(function(data){
        clearInterval(timer);
        $('#stop').prop('disabled', true);

        })
        .fail(function(){
          alert("送信に失敗しました")
        })

  });
/**
* カウントアップ
*/
  function countup()
  {
    sec += 1;

    if (sec > 59) {
      sec = 0;
      min += 1;
    }

    if (min > 59) {
      min = 0;
      hour += 1;
    }

    // 0埋め
    sec_number = ('0' + sec).slice(-2);
    min_number = ('0' + min).slice(-2);
    hour_number = ('0' + hour).slice(-2);

    $('#clock').html(hour_number + ':' +  min_number + ':' + sec_number);
  }
});

</script>

<style>
.user_show {
  margin-top:20px;
}
/* ユーザ関連 */
.user_info{
  border: 2px solid grey;
  padding: 15px;
}
.user_content {
  text-align: center;
}

/* post関連 */

.post_all{
  margin-top: 10px;
  padding:20px;
  border:2px solid grey;
}
.post_content{
  text-align:center;
}
.post_each{
  text-align:left;
}

/* ストップウォッチ関連 */
.right{
  margin: 0 10px 0 70px;
}
.stopwatch{
  float:left;
  margin-top:20px;
  width: 300px;
  height:100px;
  position:relative;
  background-color: #00FF00;
}
#clock{
  text-align:center;
  font-size:25px;
}
.timer_content{
  position:absolute;
  top: 50%;
  left: 47%;
  transform: translateY(-50%) translateX(-50%);
}
/* 新規投稿 */
.post_new{
  float:left;
  margin: 20px 0 0 20px;
  width: 300px;
  height:100px;
  position:relative;
  background-color: blue;
}
.post_link{
  color:white;
  font-size:25px;
  top: 40%;
  left: 35%;
  position: absolute;
}
</style>